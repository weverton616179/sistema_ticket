@model TicketSystem.Models.Ticket
@using TicketSystem.Models
@{
    Layout = "_Layout";
    bool isStaff = (bool)(ViewBag.IsStaff ?? false);
    string Badge(TicketStatus s) => s switch {
        TicketStatus.Open => "<span class='badge badge-open'>Aberto</span>",
        TicketStatus.InProgress => "<span class='badge badge-inprogress'>Em andamento</span>",
        TicketStatus.Closed => "<span class='badge badge-closed'>Fechado</span>",
        _ => s.ToString()
    };
}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h3>Ticket #@Model.Id — @Model.Title</h3>
        <div>Status: @Html.Raw(Badge(Model.Status))</div>
    </div>
    @if (isStaff)
    {
        <form method="post" action="/Tickets/UpdateStatus" class="d-flex align-items-center">
            <input type="hidden" name="id" value="@Model.Id" />
            <select name="status" class="form-select me-2">
                <option value="@TicketStatus.Open" selected="@(Model.Status==TicketStatus.Open)">Aberto</option>
                <option value="@TicketStatus.InProgress" selected="@(Model.Status==TicketStatus.InProgress)">Em andamento</option>
                <option value="@TicketStatus.Closed" selected="@(Model.Status==TicketStatus.Closed)">Fechado</option>
            </select>
            <button class="btn btn-primary">Atualizar</button>
        </form>
    }
</div>

<div class="card mb-3">
    <div class="card-body">
        @foreach (var m in Model.Messages.OrderBy(x => x.SentAt))
        {
            var mine = m.SenderId == User.FindFirst("sub")?.Value
                    || m.SenderId == User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

            var senderName = string.Join(" ", new[] { m.Sender?.FirstName, m.Sender?.LastName }
                                        .Where(s => !string.IsNullOrWhiteSpace(s)));

            <div class="chat-bubble @(mine ? "chat-user" : "chat-staff")">
                <small class="text-muted">
                    <strong>@(string.IsNullOrWhiteSpace(senderName) ? "Usuário" : senderName)</strong>
                    — @m.SentAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                </small>
                <div>@m.Content</div>
            </div>
        }
    </div>
</div>

<form method="post" action="/Tickets/SendMessage">
    <input type="hidden" name="id" value="@Model.Id" />
    <div class="input-group">
        <input class="form-control" name="content" placeholder="Escreva sua mensagem..." required />
        <button class="btn btn-primary">Enviar</button>
    </div>
</form>
